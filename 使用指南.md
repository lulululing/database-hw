# 📊 销售数据分析系统 - 使用指南

## 🚀 快速启动

### 1. 激活环境并启动应用
```powershell
# 激活虚拟环境
conda activate database_project

# 进入应用目录
cd d:\数据库\小组大作业\app

# 启动应用
streamlit run app.py
```

启动后浏览器会自动打开 `http://localhost:8501`

### 2. 停止应用
在 PowerShell 终端按 `Ctrl + C`

---

## 🔑 测试账号

| 角色 | 登录选择 | 密码 | 权限说明 |
|------|---------|------|---------|
| **财务总监 (FBP)** | FBP | `fbp123456` | 管理所有财务数据表，查看综合报表 |
| **经理 (Manager)** | Manager | `manager123456` | 查看历史/预测/预算对比分析 |
| **印度业务员** | Salesperson_India | `india123456` | 只能查看和修改印度数据 |
| **巴基斯坦业务员** | Salesperson_Pakistan | `pakistan123456` | 只能查看和修改巴基斯坦数据 |
| **南非业务员** | Salesperson_SouthAfrica | `southafrica123456` | 只能查看和修改南非数据 |
| **肯尼亚业务员** | Salesperson_Kenya | `kenya123456` | 只能查看和修改肯尼亚数据 |

---

## 📋 功能测试指南

### 测试 1：FBP（财务总监）权限测试

#### 登录步骤
1. 在登录页面选择 **FBP**
2. 输入密码：`fbp123456`
3. 点击"登录"

#### 功能测试清单
- ✅ **数据管理** 页面
  - 查看所有表的数据（Country, Model, Exchange, Costs, Ratio_Expenses 等）
  - 编辑数据（添加、修改、删除）
  - 导出为 Excel
  
- ✅ **综合报表** 页面
  - 查看 Display 视图（所有国家的综合数据）
  - 筛选国家、时间、型号
  - 查看收入、成本、利润等指标
  
- ✅ **数据导出**
  - 导出查询结果为 Excel

**预期结果**：能看到所有数据，可以编辑所有基础表（Model, Country, Exchange, Costs 等），但 Sales_Price 只能查看不能修改。

---

### 测试 2：Manager（经理）权限测试

#### 登录步骤
1. 在登录页面选择 **Manager**
2. 输入密码：`manager123456`
3. 点击"登录"

#### 功能测试清单
- ✅ **历史预测预算对比** 页面
  - 查看 s_Display 聚合视图
  - 对比历史、预测、预算数据
  - 按国家/型号分组查看
  - 图表展示趋势对比
  
- ✅ **报表分析**
  - 查看 s_Display_Model（按型号汇总）
  - 查看 s_Display_Country（按国家汇总）
  - 导出对比报表

**预期结果**：只能看到聚合视图（s_Display 系列），没有编辑权限，无法看到基础表数据。

---

### 测试 3：Salesperson（业务员）权限测试

#### 登录步骤（以印度为例）
1. 在登录页面选择 **Salesperson_India**
2. 输入密码：`india123456`
3. 点击"登录"

#### 功能测试清单
- ✅ **销售数据管理** 页面
  - **只能看到印度的数据**（DisplayIndia 视图）
  - 查看印度的销售、收入、利润数据
  
- ✅ **销售价格编辑**
  - 查看 Sales_Price_India 视图（只有印度的销售价格）
  - 修改印度的销售价格（Price 字段）
  - 添加新的印度销售记录
  
- ❌ **不能访问**
  - 其他国家的数据（巴基斯坦、南非、肯尼亚）
  - 基础表（Model, Country, Costs 等）
  - 综合视图（Display 全表）

**预期结果**：
- 只能看到和操作印度数据
- 尝试访问其他国家数据会报权限错误
- 可以修改印度的销售价格，但不能修改成本等其他数据

**其他国家业务员测试**：
- `Salesperson_Pakistan` → 只能看巴基斯坦
- `Salesperson_SouthAfrica` → 只能看南非
- `Salesperson_Kenya` → 只能看肯尼亚

---

## 🔍 权限隔离验证

### 验证 1：数据隔离
1. 用 `sales_india` 登录
2. 尝试在"销售数据管理"页面筛选国家
3. **预期**：下拉框中只有"India"选项，看不到其他国家

### 验证 2：编辑权限隔离
1. 用 `sales_india` 登录
2. 在"销售价格编辑"页面修改一条印度的价格
3. 保存成功后，登录 `sales_pakistan`
4. **预期**：巴基斯坦业务员看不到印度的数据变化

### 验证 3：视图权限隔离
1. 用 `manager_user` 登录
2. 尝试访问"数据管理"页面
3. **预期**：没有这个菜单选项或显示权限不足

---

## 📊 功能页面说明

### 1. 数据管理页面（FBP专属）
- **位置**：左侧菜单 → 数据管理
- **功能**：
  - 查看所有基础表（Country, Model, Exchange, Costs 等）
  - 编辑表数据（增删改）
  - 数据验证（检查外键、约束）
  - 导出为 Excel

### 2. 销售价格页面（业务员专属）
- **位置**：左侧菜单 → 销售价格
- **功能**：
  - 查看本国的销售价格（Sales_Price_<国家>）
  - 修改价格、销量
  - 添加新的销售记录
  - 导出本国数据

### 3. 综合报表页面（FBP可用）
- **位置**：左侧菜单 → 报表
- **功能**：
  - 查看 Display 视图（完整的收入成本利润计算）
  - 多维度筛选（国家、时间、型号、系列）
  - 指标对比（收入、毛利、净利润等）
  - 图表可视化

### 4. 对比分析页面（Manager专属）
- **位置**：左侧菜单 → 分析
- **功能**：
  - 历史 vs 预测 vs 预算对比
  - 按型号/国家聚合
  - 趋势图表
  - 差异分析

### 5. 历史数据页面（所有角色）
- **位置**：左侧菜单 → 历史
- **功能**：
  - 查看历史销售数据（History 表）
  - 按国家/型号筛选
  - 导出历史报表

### 6. 预算数据页面（FBP、Manager）
- **位置**：左侧菜单 → 预算
- **功能**：
  - 查看预算数据（Budget 表）
  - 对比预算与实际
  - 预算执行率分析

### 7. 成本分析页面（FBP、Manager）
- **位置**：左侧菜单 → 成本
- **功能**：
  - 查看成本构成
  - 成本率分析
  - 成本趋势图

---

## 🐛 常见问题

### 问题 1：登录后显示"连接数据库失败"
**原因**：MySQL 服务未启动或连接配置错误

**解决**：
1. 检查 Navicat 能否连接数据库
2. 确认 MySQL 服务正在运行
3. 检查 `app/config.py` 中的数据库配置：
   ```python
   DB_BASE_CONFIG = {
       'host': 'localhost',
       'port': 3306,
       'database': '大作业-test4',
   }
   ```

### 问题 2：业务员能看到其他国家数据
**原因**：数据库角色权限配置错误

**解决**：
1. 在 Navicat 中检查角色权限：
   ```sql
   SHOW GRANTS FOR 'SalespersonIndiaRole';
   ```
2. 确认只有 DisplayIndia 和 Sales_Price_India 的权限
3. 重新运行 `创建角色与权限_修复版.sql`

### 问题 3：FBP 无法修改数据
**原因**：权限不足或视图不可更新

**解决**：
1. 检查 FBPRole 的权限：
   ```sql
   SHOW GRANTS FOR 'FBPRole';
   ```
2. 确认有 ALL PRIVILEGES 在相关表上
3. 注意：视图（如 Display）通常只读，需要修改底层表

### 问题 4：Display 视图查询很慢
**原因**：视图嵌套层次深，关联多个表

**解决**：
- 在查询时**务必加上国家或时间过滤条件**
- 或者使用国家视图（DisplayIndia 等）
- 建议：
  ```sql
  SELECT * FROM Display WHERE Country = 'India' AND h_Time = '2025-12';
  ```

### 问题 5：密码错误
**原因**：输入的密码和数据库用户密码不一致

**解决**：
1. 确认使用的密码：
   - FBP: `fbp123456`
   - Manager: `manager123456`
   - Salesperson: `india123456` / `pakistan123456` 等
2. 如果修改过密码，需要同时修改 `app/config.py` 中的 ROLES 配置

---

## 🎯 测试目标与验证点

### 基础功能验证
- [ ] 所有角色都能成功登录
- [ ] 各角色看到的菜单选项符合权限设置
- [ ] 数据查询正常返回结果
- [ ] 数据导出功能正常

### 权限隔离验证
- [ ] FBP 能读写基础表
- [ ] Manager 只能读聚合视图
- [ ] 业务员只能看到和操作本国数据
- [ ] 业务员无法访问其他国家数据

### 数据一致性验证
- [ ] 修改销售价格后，Display 视图自动更新收入
- [ ] 修改成本后，毛利润自动重新计算
- [ ] 触发器正常工作（如 Model_label 验证）

### 性能验证
- [ ] Display 视图带条件查询在 5 秒内返回
- [ ] 国家视图（DisplayIndia 等）查询在 2 秒内返回
- [ ] 数据导出不超过 10 秒

---

## 📌 其他说明

### 数据更新流程
1. **基础数据**（Model, Country, Exchange）→ 由 FBP 维护
2. **销售价格**（Sales_Price）→ 由各国业务员录入
3. **成本数据**（Costs）→ 由 FBP 录入
4. **视图自动更新**（Display 等）→ 实时计算，无需手动刷新

### 角色分工建议
- **FBP**：每月初更新成本、汇率、费用率等基础数据
- **业务员**：每日录入销售价格和销量
- **Manager**：每周查看对比分析，监控预算执行

### 安全建议
- 生产环境中，将 `'%'` 改为具体 IP 地址
- 定期修改用户密码
- 使用 SSL 连接数据库
- 定期备份数据库

---

## 🆘 获取帮助

如果遇到问题：
1. 查看 PowerShell 终端的错误信息
2. 检查 Navicat 中的数据库连接
3. 验证用户权限：`SHOW GRANTS FOR '用户名'@'%';`
4. 查看应用日志（Streamlit 终端输出）

---

**祝测试顺利！** 🎉

有问题随时在终端查看详细错误信息，或检查 Navicat 中的权限设置。
