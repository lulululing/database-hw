# 数据库导入指南（分步方案）

## 问题说明
Navicat 的"运行 SQL 文件"功能**不支持 DELIMITER 命令**，会导致：
- 触发器创建失败
- 触发器之前的所有表无法创建
- 只有视图被创建（因为在触发器之后）

## ✅ 正确导入步骤

### 准备工作
1. **删除现有数据库**（如果已创建）：
   - 右键 `大作业-test4` → 删除数据库
2. **重新创建空数据库**：
   - 右键连接 → 新建数据库 → 名称：`大作业-test4` → 字符集：utf8mb4 → 排序规则：utf8mb4_general_ci

### 步骤 1：创建表和索引
```
文件：1_创建表和索引.sql
方法：右键数据库 → 运行 SQL 文件 → 选择此文件
预期：创建 11 张表和 6 个索引
```

**验证：**
```sql
SHOW TABLES IN `大作业-test4`;
-- 应该看到：Country, Model, Exchange, Sales_Price, Costs, Ratio_Expenses1/2/3, 
--          Regional_Expenses, History, Budget
```

### 步骤 2：插入数据
```
文件：2_插入数据.sql
方法：右键数据库 → 运行 SQL 文件 → 选择此文件
预期：插入所有基础数据
```

**验证：**
```sql
SELECT COUNT(*) FROM Country;        -- 应该是 6
SELECT COUNT(*) FROM Sales_Price;    -- 应该是 20
SELECT COUNT(*) FROM History;        -- 应该是 8
SELECT COUNT(*) FROM Budget;         -- 应该是 32
```

### 步骤 3：创建触发器 ⚠️
```
文件：3_创建触发器.sql
方法：打开 Navicat 查询窗口 → 复制文件全部内容粘贴 → 点击"运行"（F5）
重要：不要用"运行 SQL 文件"，必须在查询窗口手动执行！
预期：创建 2 个触发器
```

**验证：**
```sql
SHOW TRIGGERS IN `大作业-test4`;
-- 应该看到：validate_model_label_insert, validate_model_label_update
```

### 步骤 4：创建视图
```
文件：4_创建视图.sql
方法：右键数据库 → 运行 SQL 文件 → 选择此文件
预期：创建 17 个视图
```

**验证：**
```sql
SHOW FULL TABLES IN `大作业-test4` WHERE Table_type = 'VIEW';
-- 应该看到：true_Price, true_Revenues, true_Expenses, true_Margin_profits, true_Net_income,
--          Display, Sales_Price_India/Pakistan/South_Africa/Kenya,
--          DisplayIndia/Pakistan/SouthAfrica/Kenya,
--          s_Display, s_Display_Model, s_Display_Country
```

### 步骤 5：创建角色与权限
```
文件：创建角色与权限_修复版.sql
方法：右键数据库 → 运行 SQL 文件 → 选择此文件
预期：创建 6 个角色并授权
```

**验证：**
```sql
SELECT user FROM mysql.user WHERE user LIKE '%Role%';
-- 应该看到：FBPRole, SalespersonIndiaRole, SalespersonPakistanRole, 
--          SalespersonSouthAfricaRole, SalespersonKenyaRole, ManagerRole

SHOW GRANTS FOR 'FBPRole';
SHOW GRANTS FOR 'ManagerRole';
```

## 🔍 最终验证查询
全部导入成功后，运行以下查询测试：

```sql
-- 测试基础表
SELECT * FROM Country;
SELECT * FROM Model;

-- 测试视图
SELECT COUNT(*) FROM Display;                    -- 应该有 20 行
SELECT COUNT(*) FROM Sales_Price_South_Africa;   -- 应该有数据
SELECT * FROM s_Display LIMIT 5;                 -- 查看聚合视图

-- 测试触发器（应该报错，因为 'XX' 不是有效的 Model_label）
INSERT INTO Ratio_Expenses3(Ratio_expenses3_id, Model_label, Country, After_sales_provision_rate_acc_cost)
VALUES (999, 'XX', 'India', 0.0250);
-- 预期错误：Model_label does not exist in Model table
```

## ⚠️ 常见问题

### 问题：运行 3_创建触发器.sql 报错
**原因**：用了"运行 SQL 文件"而不是查询窗口  
**解决**：打开查询窗口，手动粘贴内容执行

### 问题：视图查询超时或一直转圈
**原因**：基础表未创建，视图查询失败  
**解决**：检查 `SHOW TABLES` 确认表存在，如果不存在，从步骤 1 重新导入

### 问题：角色创建报 1396 错误
**原因**：角色已存在（之前创建过）  
**解决**：脚本已包含 `DROP ROLE IF EXISTS`，如还报错，手动执行：
```sql
DROP ROLE IF EXISTS 'FBPRole', 'SalespersonIndiaRole', 'SalespersonPakistanRole', 
                     'SalespersonSouthAfricaRole', 'SalespersonKenyaRole', 'ManagerRole';
```

### 问题：GRANT 报 1146（表/视图不存在）
**原因**：视图名称拼写错误或视图未创建  
**解决**：确认步骤 4 成功执行，检查 `SHOW FULL TABLES ... WHERE Table_type = 'VIEW'`

## 📝 后续步骤
导入完成后：
1. 运行用户创建脚本（如果有），将角色分配给具体用户
2. 测试 Streamlit 应用连接
3. 验证不同角色的权限是否正确隔离

---
**如遇到任何错误，请截图完整的错误信息（包括错误代码和具体 SQL 语句）以便快速定位问题。**
